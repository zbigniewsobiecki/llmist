# Test Dockerfile to validate npm packages install and work correctly
# Usage:
#   docker build -f Dockerfile.test-npm -t llmist-test .
#   docker run --rm -e GEMINI_API_KEY="your-key" llmist-test
#   docker run --rm -e GEMINI_API_KEY="key" -e ANTHROPIC_API_KEY="key" llmist-test

FROM node:22-slim

# Install build tools for native dependencies (better-sqlite3, sharp) and bun
RUN apt-get update && apt-get install -y \
    python3 \
    build-essential \
    git \
    curl \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Install bun (required for external gadget installation from git URLs)
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:$PATH"

WORKDIR /app

# Install packages from npm (not from local workspace)
# Use --force to ensure we get the exact version even if cached
RUN npm cache clean --force && \
    npm install -g @llmist/cli@8.1.1 && \
    npm install llmist@8.1.1

# Create a simple test script for llmist library
RUN cat > test-library.mjs << 'EOF'
import { LLMist } from 'llmist';

async function main() {
  console.log('‚úÖ llmist package imported successfully\n');

  // Test basic agent creation and run
  const agent = LLMist.createAgent()
    .withModel('gemini:gemini-2.0-flash')
    .withSystem('You are a helpful assistant. Be very brief.')
    .ask('Say "Hello from llmist!" and nothing else.');

  console.log('ü§ñ Testing Gemini API via llmist...\n');

  // Collect text from the streaming response
  let text = '';
  for await (const event of agent.run()) {
    if (event.type === 'text') {
      text += event.content;
    }
  }

  console.log('üì§ Response:', text);

  if (!text || text.length === 0) {
    throw new Error('No response received from LLM');
  }

  console.log('\n‚úÖ llmist library test passed!\n');
}

main().catch(err => {
  console.error('‚ùå Test failed:', err.message);
  process.exit(1);
});
EOF

# Create entrypoint script that runs all tests
RUN cat > entrypoint.sh << 'EOF'
#!/bin/bash
set -e

echo "================================================"
echo "üß™ Testing llmist npm packages"
echo "================================================"
echo ""

# Check if GEMINI_API_KEY is set
if [ -z "$GEMINI_API_KEY" ]; then
  echo "‚ö†Ô∏è  GEMINI_API_KEY not set - skipping API tests"
  echo ""
  echo "To run full tests:"
  echo "  docker run --rm -e GEMINI_API_KEY=key llmist-test"
  echo ""
  echo "To also test dhalsim BrowseWeb:"
  echo "  docker run --rm -e GEMINI_API_KEY=key -e ANTHROPIC_API_KEY=key llmist-test"
  echo ""

  # Just verify packages are installed
  echo "üì¶ Verifying package installation..."
  echo ""
  llmist --version
  echo ""
  node -e "import('llmist').then(m => console.log('‚úÖ llmist package loads correctly'))"
  echo ""
  echo "‚úÖ Package installation verified!"
  exit 0
fi

echo "üì¶ Package versions:"
echo "   llmist CLI: $(llmist --version)"
LIB_VERSION=$(node -e "import('llmist').then(m => console.log(m.LLMist ? '8.1.1' : 'unknown'))")
echo "   llmist lib: $LIB_VERSION"
echo ""

echo "================================================"
echo "üî¨ Test 1: llmist library (programmatic API)"
echo "================================================"
echo ""
node test-library.mjs

echo "================================================"
echo "üî¨ Test 2: @llmist/cli (command line)"
echo "================================================"
echo ""
echo "Running: llmist complete 'Say hello briefly'"
echo ""
llmist complete "Say 'CLI test successful!' and nothing else." --model gemini:gemini-2.0-flash

echo ""
echo "================================================"
echo "üî¨ Test 3: External gadgets from git URL (dhalsim)"
echo "================================================"
echo ""

echo "üì• Installing dhalsim from git+https://github.com/zbigniewsobiecki/dhalsim.git#dev..."
echo ""

# Test loading external gadgets - this installs dhalsim to ~/.llmist/gadget-cache/
# Use a simple prompt that will just list available gadgets
llmist agent "List the gadgets you have available. Just list their names, nothing else." \
  -g "git+https://github.com/zbigniewsobiecki/dhalsim.git#dev:minimal" \
  --model gemini:gemini-2.0-flash \
  --max-iterations 1 \
  2>&1 && echo "" && echo "‚úÖ dhalsim gadgets loaded successfully!" || {
    echo ""
    echo "‚ö†Ô∏è  Failed to load dhalsim gadgets"
    echo "   This may be due to native dependencies (better-sqlite3, sharp)"
    echo "   Continuing with other tests..."
  }

echo ""

# Test BrowseWeb subagent if ANTHROPIC_API_KEY is set (BrowseWeb uses sonnet by default)
if [ -n "$ANTHROPIC_API_KEY" ]; then
  echo "================================================"
  echo "üî¨ Test 4: dhalsim BrowseWeb subagent"
  echo "================================================"
  echo ""
  echo "üåê Running BrowseWeb subagent to fetch example.com title..."
  echo ""

  # Use the subagent preset which loads the BrowseWeb gadget
  llmist agent "Navigate to example.com and tell me the page title. Be very brief - just say the title." \
    -g "git+https://github.com/zbigniewsobiecki/dhalsim.git#dev:subagent" \
    --model sonnet \
    --max-iterations 5 \
    2>&1 || {
      echo ""
      echo "‚ö†Ô∏è  BrowseWeb test failed (browser may not be available in container)"
      echo "   This is expected in minimal Docker environments."
    }
  echo ""
else
  echo "‚ÑπÔ∏è  Skipping BrowseWeb test (ANTHROPIC_API_KEY not set)"
  echo "   BrowseWeb uses Claude Sonnet by default"
  echo ""
fi

echo "================================================"
echo "‚úÖ All tests completed!"
echo "================================================"
EOF

RUN chmod +x entrypoint.sh

ENTRYPOINT ["./entrypoint.sh"]
