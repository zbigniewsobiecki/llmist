name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no publish)'
        required: false
        default: false
        type: boolean
      force_publish:
        description: 'Force publish current versions (skip semantic-release)'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/**'

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    environment: CI
    # Skip if commit message contains [skip release] or [release skip]
    if: ${{ !contains(github.event.head_commit.message, '[skip release]') && !contains(github.event.head_commit.message, '[release skip]') }}
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for semantic-release to analyze all commits
          fetch-depth: 0
          # Use PAT for authenticated pushes (allows triggering workflows and bypassing branch protection)
          token: ${{ secrets.GH_PAT }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: bun install

      - name: Build package
        run: bun run build

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config core.hooksPath /dev/null

      - name: Force publish (skip semantic-release)
        if: ${{ github.event.inputs.force_publish == 'true' }}
        id: force_publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION=$(node -p "require('./packages/llmist/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Check if llmist@VERSION is already published
          if npm view llmist@$VERSION version 2>/dev/null; then
            echo "‚è≠Ô∏è  llmist@$VERSION already published, skipping..."
          else
            echo "üöÄ Force publishing llmist@$VERSION..."
            cd packages/llmist && npm publish --access public
            cd ../..
          fi

          # Check if @llmist/cli@VERSION is already published
          if npm view @llmist/cli@$VERSION version 2>/dev/null; then
            echo "‚è≠Ô∏è  @llmist/cli@$VERSION already published, skipping..."
          else
            echo "üöÄ Force publishing @llmist/cli@$VERSION..."
            cd packages/cli && npm publish --access public
          fi

          echo "‚úÖ Force publish complete!"

      - name: Run semantic-release
        if: ${{ github.event.inputs.force_publish != 'true' }}
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          BEFORE_SHA=$(git rev-parse HEAD)
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "Running in dry-run mode"
            bunx semantic-release --dry-run
          else
            # Run semantic-release (publishes llmist package to npm)
            # The @semantic-release/exec plugin runs sync-versions.js to sync all package versions
            bunx semantic-release || RELEASE_EXIT_CODE=$?
          fi
          AFTER_SHA=$(git rev-parse HEAD)
          # Check if a release commit was made (HEAD changed)
          if [ "$BEFORE_SHA" != "$AFTER_SHA" ]; then
            echo "released=true" >> $GITHUB_OUTPUT
            # Extract version from the release commit
            VERSION=$(node -p "require('./packages/llmist/package.json').version")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "‚úÖ Release $VERSION created"
          else
            echo "released=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No release commit - skipping publish"
          fi
          # Exit with the original exit code if semantic-release failed
          exit ${RELEASE_EXIT_CODE:-0}

      - name: Publish @llmist/cli to npm
        if: ${{ steps.semantic.outputs.released == 'true' && github.event.inputs.dry_run != 'true' && github.event.inputs.force_publish != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Publishing @llmist/cli@${{ steps.semantic.outputs.version }}..."
          # Rebuild CLI to include correct version (was built before version sync)
          cd packages/cli
          bun run build
          npm publish --access public

      - name: Sync dev branch
        if: ${{ always() && steps.semantic.outputs.released == 'true' && github.event.inputs.dry_run != 'true' }}
        continue-on-error: true
        run: |
          # Fetch latest changes from remote
          git fetch origin

          # Check out dev branch
          git checkout dev || git checkout -b dev origin/dev

          # Fast-forward dev to match main (no merge commits)
          # This works because all changes flow through feature branches -> dev -> main
          # After a release, dev should always be able to fast-forward to main
          git merge origin/main --ff-only --no-edit -m "chore: sync dev with main after release [skip ci]" || {
            echo "‚ö†Ô∏è  Warning: Could not fast-forward dev to main. Dev has diverged."
            echo "This usually means there are commits on dev that aren't on main."
            echo "Falling back to regular merge to keep branches in sync."
            git merge origin/main --no-edit -m "chore: sync dev with main after release [skip ci]"
          }

          # Push changes
          git push origin dev
