name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no publish)'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/**'

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    environment: CI
    # Skip if commit message contains [skip release] or [release skip]
    if: ${{ !contains(github.event.head_commit.message, '[skip release]') && !contains(github.event.head_commit.message, '[release skip]') }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for semantic-release to analyze all commits
          fetch-depth: 0
          # Use PAT for authenticated pushes (allows triggering workflows and bypassing branch protection)
          token: ${{ secrets.GH_PAT }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: bun install

      - name: Build package
        run: bun run build

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config core.hooksPath /dev/null

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "Running in dry-run mode"
            bunx semantic-release --dry-run
          else
            bunx semantic-release
          fi

      - name: Sync dev branch
        if: ${{ success() && github.event.inputs.dry_run != 'true' }}
        run: |
          # Fetch latest changes from remote
          git fetch origin

          # Check out dev branch
          git checkout dev || git checkout -b dev origin/dev

          # Fast-forward dev to match main (no merge commits)
          # This works because all changes flow through feature branches -> dev -> main
          # After a release, dev should always be able to fast-forward to main
          git merge origin/main --ff-only --no-edit -m "chore: sync dev with main after release [skip ci]" || {
            echo "⚠️  Warning: Could not fast-forward dev to main. Dev has diverged."
            echo "This usually means there are commits on dev that aren't on main."
            echo "Falling back to regular merge to keep branches in sync."
            git merge origin/main --no-edit -m "chore: sync dev with main after release [skip ci]"
          }

          # Push changes
          git push origin dev
